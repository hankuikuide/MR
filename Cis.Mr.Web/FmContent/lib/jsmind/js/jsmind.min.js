!function(e){"use strict";var t="jsMind",n="0.4a",i="hizzgdev@163.com",o=function(){},r="undefined"==typeof console?{log:o,debug:o,error:o,warn:o,info:o}:console;if("undefined"!=typeof e[t])return void r.log(t+" has been already exist.");var d=e.document,a=function(e){return d.getElementById(e)},s=function(e){return d.createElement(e)},l=function(e,t){e.hasChildNodes()?e.firstChild.nodeValue=t:e.appendChild(d.createTextNode(t))},h=function(e,t){e.innerHTML=t},_={container:"",editable:!1,theme:null,mode:"full",support_html:!0,view:{hmargin:100,vmargin:50,line_width:2,line_color:["#ff0000"]},layout:{hspace:30,vspace:20,pspace:13},default_event_handle:{enable_mousedown_handle:!0,enable_click_handle:!0,enable_dblclick_handle:!0},shortcut:{enable:!0,handles:{},mapping:{addchild:45,addbrother:13,editnode:113,delnode:46,toggle:32,left:37,up:38,right:39,down:40}}},u=function(e){u.current=this,this.version=n;var t={};return u.util.json.merge(t,_),u.util.json.merge(t,e),null==t.container||0==t.container.length?void r.error("the options.container should not be empty."):(this.options=t,this.inited=!1,this.mind=null,this.event_handles=[],void this.init())};u.direction={left:-1,center:0,right:1},u.event_type={show:1,resize:2,edit:3,select:4},u.node=function(e,t,n,i,o,d,a,s){return e?"number"!=typeof t?void r.error("invalid node index"):("undefined"==typeof s&&(s=!0),this.id=e,this.index=t,this.topic=n,this.data=i||{},this.isroot=o,this.parent=d,this.direction=a,this.expanded=!!s,this.children=[],void(this._data={})):void r.error("invalid nodeid")},u.node.compare=function(e,t){var n=0,i=e.index,o=t.index;return n=i>=0&&o>=0?i-o:-1==i&&-1==o?0:-1==i?1:-1==o?-1:0},u.node.inherited=function(e,t){if(e&&t){if(e.id===t.id)return!0;if(e.isroot)return!0;for(var n=e.id,i=t;!i.isroot;)if(i=i.parent,i.id===n)return!0}return!1},u.node.prototype={get_location:function(){var e=this._data.view;return{x:e.abs_x,y:e.abs_y}},get_size:function(){var e=this._data.view;return{w:e.width,h:e.height}}},u.mind=function(){this.name=null,this.author=null,this.version=null,this.root=null,this.selected=null,this.nodes={}},u.mind.prototype={get_node:function(e){return e in this.nodes?this.nodes[e]:(r.warn("the node[id="+e+"] can not be found"),null)},set_root:function(e,t,n){null==this.root?(this.root=new u.node(e,0,t,n,!0),this._put_node(this.root)):r.error("root node is already exist")},add_node:function(e,t,n,i,o,d,a){if("string"==typeof e)return this.add_node(this.get_node(e),t,n,i,o,d,a);var s=o||-1;if(e){var l=null;if(e.isroot){var h=u.direction.right;if(isNaN(d)){for(var _=e.children,c=_.length,f=0,v=0;c>v;v++)_[v].direction===u.direction.left?f--:f++;h=c>1&&f>0?u.direction.left:u.direction.right}else h=d!=u.direction.left?u.direction.right:u.direction.left;l=new u.node(t,s,n,i,!1,e,h,a)}else l=new u.node(t,s,n,i,!1,e,e.direction,a);return this._put_node(l)?(e.children.push(l),this._reindex(e)):(r.error("fail, the nodeid '"+l.id+"' has been already exist."),l=null),l}return r.error("fail, the [node_parent] can not be found."),null},insert_node_before:function(e,t,n,i){if("string"==typeof e)return this.insert_node_before(this.get_node(e),t,n,i);if(e){var o=e.index-.5;return this.add_node(e.parent,t,n,i,o)}return r.error("fail, the [node_before] can not be found."),null},get_node_before:function(e){if(!e)return null;if("string"==typeof e)return this.get_node_before(this.get_node(e));if(e.isroot)return null;var t=e.index-2;return t>=0?e.parent.children[t]:null},insert_node_after:function(e,t,n,i){if("string"==typeof e)return this.insert_node_after(this.get_node(e),t,n,i);if(e){var o=e.index+.5;return this.add_node(e.parent,t,n,i,o)}return r.error("fail, the [node_after] can not be found."),null},get_node_after:function(e){if(!e)return null;if("string"==typeof e)return this.get_node_after(this.get_node(e));if(e.isroot)return null;var t=e.index,n=e.parent.children;return n.length>=t?e.parent.children[t]:null},move_node:function(e,t,n,i){return"string"==typeof e?this.move_node(this.get_node(e),t,n,i):(n||(n=e.parent.id),this._move_node(e,t,n,i))},_flow_node_direction:function(e,t){"undefined"==typeof t?t=e.direction:e.direction=t;for(var n=e.children.length;n--;)this._flow_node_direction(e.children[n],t)},_move_node_internal:function(e,t){if(e&&t)if("_last_"==t)e.index=-1,this._reindex(e.parent);else if("_first_"==t)e.index=0,this._reindex(e.parent);else{var n=t?this.get_node(t):null;null!=n&&null!=n.parent&&n.parent.id==e.parent.id&&(e.index=n.index-.5,this._reindex(e.parent))}return e},_move_node:function(e,t,n,i){if(e&&n){if(e.parent.id!=n){for(var o=e.parent.children,r=o.length;r--;)if(o[r].id==e.id){o.splice(r,1);break}e.parent=this.get_node(n),e.parent.children.push(e)}e.direction=e.parent.isroot?i==jsMind.direction.left?i:u.direction.right:e.parent.direction,this._move_node_internal(e,t),this._flow_node_direction(e)}return e},remove_node:function(e){if("string"==typeof e)return this.remove_node(this.get_node(e));if(!e)return r.error("fail, the node can not be found"),!1;if(e.isroot)return r.error("fail, can not remove root node"),!1;null!=this.selected&&this.selected.id==e.id&&(this.selected=null);for(var t=e.children,n=t.length;n--;)this.remove_node(t[n]);t.length=0;for(var i=e.parent.children,o=i.length;o--;)if(i[o].id==e.id){i.splice(o,1);break}delete this.nodes[e.id];for(var d in e)delete e[d];return e=null,!0},_put_node:function(e){return e.id in this.nodes?(r.warn("the nodeid '"+e.id+"' has been already exist."),!1):(this.nodes[e.id]=e,!0)},_reindex:function(e){if(e instanceof u.node){e.children.sort(u.node.compare);for(var t=0;t<e.children.length;t++)e.children[t].index=t+1}}},u.format={node_tree:{example:{meta:{name:t,author:i,version:n},format:"node_tree",data:{id:"root",topic:"jsMind Example"}},get_mind:function(e){var t=u.format.node_tree,n=new u.mind;return n.name=e.meta.name,n.author=e.meta.author,n.version=e.meta.version,t._parse(n,e.data),n},get_data:function(e){var t=u.format.node_tree,n={};return n.meta={name:e.name,author:e.author,version:e.version},n.format="node_tree",n.data=t._buildnode(e.root),n},_parse:function(e,t){var n=u.format.node_tree,i=n._extract_data(t);if(e.set_root(t.id,t.topic,i),"children"in t)for(var o=t.children,r=0;r<o.length;r++)n._extract_subnode(e,e.root,o[r])},_extract_data:function(e){var t={};for(var n in e)"id"!=n&&"topic"!=n&&"children"!=n&&"direction"!=n&&"expanded"!=n&&(t[n]=e[n]);return t},_extract_subnode:function(e,t,n){var i=u.format.node_tree,o=i._extract_data(n),r=null;t.isroot&&(r="left"==n.direction?u.direction.left:u.direction.right);var d=e.add_node(t,n.id,n.topic,o,null,r,n.expanded);if("children"in n)for(var a=n.children,s=0;s<a.length;s++)i._extract_subnode(e,d,a[s])},_buildnode:function(e){var t=u.format.node_tree;if(e instanceof u.node){var n={id:e.id,topic:e.topic,expanded:e.expanded};if(e.parent&&e.parent.isroot&&(n.direction=e.direction==u.direction.left?"left":"right"),null!=e.data){var i=e.data;for(var o in i)n[o]=i[o]}var r=e.children;if(r.length>0){n.children=[];for(var d=0;d<r.length;d++)n.children.push(t._buildnode(r[d]))}return n}}},node_array:{example:{meta:{name:t,author:i,version:n},format:"node_array",data:[{id:"root",topic:"jsMind Example",isroot:!0}]},get_mind:function(e){var t=u.format.node_array,n=new u.mind;return n.name=e.meta.name,n.author=e.meta.author,n.version=e.meta.version,t._parse(n,e.data),n},get_data:function(e){var t=u.format.node_array,n={};return n.meta={name:e.name,author:e.author,version:e.version},n.format="node_array",n.data=[],t._array(e,n.data),n},_parse:function(e,t){var n=u.format.node_array,i=t.slice(0);i.reverse();var o=n._extract_root(e,i);o?n._extract_subnode(e,o,i):r.error("root node can not be found")},_extract_root:function(e,t){for(var n=u.format.node_array,i=t.length;i--;)if("isroot"in t[i]&&t[i].isroot){var o=t[i],r=n._extract_data(o);return e.set_root(o.id,o.topic,r),t.splice(i,1),o.id}return null},_extract_subnode:function(e,t,n){for(var i=u.format.node_array,o=n.length,r=null,d=null,a=0;o--;)if(r=n[o],r.parentid==t){d=i._extract_data(r);var s=null,l=r.direction;l&&(s="left"==l?u.direction.left:u.direction.right),e.add_node(t,r.id,r.topic,d,null,s,r.expanded),n.splice(o,1),a++;var h=i._extract_subnode(e,r.id,n);h>0&&(o=n.length,a+=h)}return a},_extract_data:function(e){var t={};for(var n in e)"id"!=n&&"topic"!=n&&"parentid"!=n&&"isroot"!=n&&"direction"!=n&&"expanded"!=n&&(t[n]=e[n]);return t},_array:function(e,t){var n=u.format.node_array;n._array_node(e.root,t)},_array_node:function(e,t){var n=u.format.node_array;if(e instanceof u.node){var i={id:e.id,topic:e.topic,expanded:e.expanded};if(e.parent&&(i.parentid=e.parent.id),e.isroot&&(i.isroot=!0),e.parent&&e.parent.isroot&&(i.direction=e.direction==u.direction.left?"left":"right"),null!=e.data){var o=e.data;for(var r in o)i[r]=o[r]}t.push(i);for(var d=e.children.length,a=0;d>a;a++)n._array_node(e.children[a],t)}}},freemind:{example:{meta:{name:t,author:i,version:n},format:"freemind",data:'<map version="1.0.1"><node ID="root" TEXT="freemind Example"/></map>'},get_mind:function(e){var t=u.format.freemind,n=new u.mind;n.name=e.meta.name,n.author=e.meta.author,n.version=e.meta.version;var i=e.data,o=t._parse_xml(i),r=t._find_root(o);return t._load_node(n,null,r),n},get_data:function(e){var t=u.format.freemind,n={};n.meta={name:e.name,author:e.author,version:e.version},n.format="freemind";var i=[];return i.push('<map version="1.0.1">'),t._buildmap(e.root,i),i.push("</map>"),n.data=i.join(" "),n},_parse_xml:function(e){var t=null;if(window.DOMParser){var n=new DOMParser;t=n.parseFromString(e,"text/xml")}else t=new ActiveXObject("Microsoft.XMLDOM"),t.async=!1,t.loadXML(e);return t},_find_root:function(e){for(var t=e.childNodes,n=null,i=null,o=0;o<t.length;o++)if(i=t[o],1==i.nodeType&&"map"==i.tagName){n=i;break}if(n){var r=n.childNodes;n=null;for(var o=0;o<r.length;o++)if(i=r[o],1==i.nodeType&&"node"==i.tagName){n=i;break}}return n},_load_node:function(e,t,n){var i=u.format.freemind,o=n.getAttribute("ID"),r=n.getAttribute("TEXT");if(null==r)for(var d=n.childNodes,a=null,s=0;s<d.length;s++)if(a=d[s],1==a.nodeType&&"richcontent"===a.tagName){r=a.textContent;break}var l=i._load_attributes(n),h="expanded"in l?"true"==l.expanded:!0;delete l.expanded;var _=n.getAttribute("POSITION"),c=null;_&&(c="left"==_?u.direction.left:u.direction.right),t?e.add_node(t,o,r,l,null,c,h):e.set_root(o,r,l);for(var f=n.childNodes,v=null,s=0;s<f.length;s++)v=f[s],1==v.nodeType&&"node"==v.tagName&&i._load_node(e,o,v)},_load_attributes:function(e){for(var t=e.childNodes,n=null,i={},o=0;o<t.length;o++)n=t[o],1==n.nodeType&&"attribute"===n.tagName&&(i[n.getAttribute("NAME")]=n.getAttribute("VALUE"));return i},_buildmap:function(e,t){var n=u.format.freemind,i=null;e.parent&&e.parent.isroot&&(i=e.direction===u.direction.left?"left":"right"),t.push("<node"),t.push('ID="'+e.id+'"'),i&&t.push('POSITION="'+i+'"'),t.push('TEXT="'+e.topic+'">'),t.push('<attribute NAME="expanded" VALUE="'+e.expanded+'"/>');var o=e.data;if(null!=o)for(var r in o)t.push('<attribute NAME="'+r+'" VALUE="'+o[r]+'"/>');for(var d=e.children,a=0;a<d.length;a++)n._buildmap(d[a],t);t.push("</node>")}}},u.util={ajax:{_xhr:function(){var e=null;if(window.XMLHttpRequest)e=new XMLHttpRequest;else try{e=new ActiveXObject("Microsoft.XMLHTTP")}catch(t){}return e},_eurl:function(e){return encodeURIComponent(e)},request:function(e,t,n,i,o){var d=u.util.ajax,a=null,s=[];for(k in t)s.push(d._eurl(k)+"="+d._eurl(t[k]));s.length>0&&(a=s.join("&"));var l=d._xhr();l&&(l.onreadystatechange=function(){if(4==l.readyState)if(200==l.status||0==l.status){if("function"==typeof i){var e=u.util.json.string2json(l.responseText);i(null!=e?e:l.responseText)}}else"function"==typeof o?o(l):r.error("xhr request failed.",l)},n=n||"GET",l.open(n,e,!0),l.setRequestHeader("If-Modified-Since","0"),"POST"==n?(l.setRequestHeader("Content-Type","application/x-www-form-urlencoded;charset=utf-8"),l.send(a)):l.send())},get:function(e,t){return u.util.ajax.request(e,{},"GET",t)},post:function(e,t,n){return u.util.ajax.request(e,t,"POST",n)}},dom:{add_event:function(e,t,n){e.addEventListener?e.addEventListener(t,n,!1):e.attachEvent("on"+t,n)}},canvas:{bezierto:function(e,t,n,i,o){e.beginPath(),e.moveTo(t,n),e.bezierCurveTo(t+2*(i-t)/3,n,t,o,i,o),e.stroke()},lineto:function(e,t,n,i,o){e.beginPath(),e.moveTo(t,n),e.lineTo(i,o),e.stroke()},clear:function(e,t,n,i,o){e.clearRect(t,n,i,o)}},file:{read:function(e,t){var n=new FileReader;n.onload=function(){"function"==typeof t&&t(this.result,e.name)},n.readAsText(e)},save:function(t,n,i){var o;if("function"==typeof e.Blob)o=new Blob([t],{type:n});else{var r=e.BlobBuilder||e.MozBlobBuilder||e.WebKitBlobBuilder||e.MSBlobBuilder,a=new r;a.append(t),o=a.getBlob(n)}if(navigator.msSaveBlob)navigator.msSaveBlob(o,i);else{var l=e.URL||e.webkitURL,h=l.createObjectURL(o),_=s("a");if("download"in _){_.style.visibility="hidden",_.href=h,_.download=i,d.body.appendChild(_);var u=d.createEvent("MouseEvents");u.initEvent("click",!0,!0),_.dispatchEvent(u),d.body.removeChild(_)}else location.href=h}}},json:{json2string:function(e){if(JSON)try{var t=JSON.stringify(e);return t}catch(n){return r.warn(n),r.warn("can not convert to string"),null}},string2json:function(e){if(JSON)try{var t=JSON.parse(e);return t}catch(n){return r.warn(n),r.warn("can not parse to json"),null}},merge:function(e,t){for(var n in t)n in e?"object"!=typeof e[n]||"[object object]"!=Object.prototype.toString.call(e[n]).toLowerCase()||e[n].length?e[n]=t[n]:u.util.json.merge(e[n],t[n]):e[n]=t[n];return e}},uuid:{newid:function(){return((new Date).getTime().toString(16)+Math.random().toString(16).substr(2)).substr(2,16)}},text:{is_empty:function(e){return e?0==e.replace(/\s*/,"").length:!0}}},u.prototype={init:function(){if(!this.inited){this.inited=!0;var e=this.options,t={mode:e.mode,hspace:e.layout.hspace,vspace:e.layout.vspace,pspace:e.layout.pspace},n={container:e.container,support_html:e.support_html,hmargin:e.view.hmargin,vmargin:e.view.vmargin,line_width:e.view.line_width,line_color:e.view.line_color};this.data=new u.data_provider(this),this.layout=new u.layout_provider(this,t),this.view=new u.view_provider(this,n),this.shortcut=new u.shortcut_provider(this,e.shortcut),this.data.init(),this.layout.init(),this.view.init(),this.shortcut.init(),this._event_bind(),u.init_plugins(this)}},enable_edit:function(){this.options.editable=!0},disable_edit:function(){this.options.editable=!1},enable_event_handle:function(e){this.options.default_event_handle["enable_"+e+"_handle"]=!0},disable_event_handle:function(e){this.options.default_event_handle["enable_"+e+"_handle"]=!1},get_editable:function(){return this.options.editable},set_theme:function(e){var t=this.options.theme;this.options.theme=e?e:null,t!=this.options.theme&&(this.view.reset_theme(),this.view.reset_custom_style())},_event_bind:function(){this.view.add_event(this,"mousedown",this.mousedown_handle),this.view.add_event(this,"click",this.click_handle),this.view.add_event(this,"dblclick",this.dblclick_handle)},mousedown_handle:function(e){if(this.options.default_event_handle.enable_mousedown_handle){var t=e.target||event.srcElement,n=this.view.get_binded_nodeid(t);n?this.select_node(n):this.select_clear()}},click_handle:function(e){if(this.options.default_event_handle.enable_click_handle){var t=e.target||event.srcElement,n=this.view.is_expander(t);if(n){var i=this.view.get_binded_nodeid(t);i&&this.toggle_node(i)}}},dblclick_handle:function(e){if(this.options.default_event_handle.enable_dblclick_handle&&this.get_editable()){var t=e.target||event.srcElement,n=this.view.get_binded_nodeid(t);n&&this.begin_edit(n)}},begin_edit:function(e){return"string"==typeof e?this.begin_edit(this.get_node(e)):this.get_editable()?void(e?this.view.edit_node_begin(e):r.error("the node can not be found")):void r.error("fail, this mind map is not editable.")},end_edit:function(){this.view.edit_node_end()},toggle_node:function(e){if("string"==typeof e)return this.toggle_node(this.get_node(e));if(e){if(e.isroot)return;this.layout.toggle_node(e),this.view.relayout()}else r.error("the node can not be found.")},expand_node:function(e){if("string"==typeof e)return this.expand_node(this.get_node(e));if(e){if(e.isroot)return;this.layout.expand_node(e),this.view.relayout()}else r.error("the node can not be found.")},collapse_node:function(e){if("string"==typeof e)return this.collapse_node(this.get_node(e));if(e){if(e.isroot)return;this.layout.collapse_node(e),this.view.relayout()}else r.error("the node can not be found.")},expand_all:function(){this.layout.expand_all(),this.view.relayout()},expand_to_depth:function(e){this.layout.expand_to_depth(e),this.view.relayout()},_reset:function(){this.view.reset(),this.layout.reset(),this.data.reset()},_show:function(e){var t=e||u.format.node_array.example;return this.mind=this.data.load(t),this.mind?(r.debug("data.load ok"),this.view.load(),r.debug("view.load ok"),this.layout.layout(),r.debug("layout.layout ok"),this.view.show(!0),r.debug("view.show ok"),void this.invoke_event_handle(u.event_type.show,{data:[e]})):void r.error("data.load error")},show:function(e){this._reset(),this._show(e)},get_meta:function(){return{name:this.mind.name,author:this.mind.author,version:this.mind.version}},get_data:function(e){var t=e||"node_tree";return this.data.get_data(t)},get_root:function(){return this.mind.root},get_node:function(e){return this.mind.get_node(e)},add_node:function(e,t,n,i){if(this.get_editable()){var o=this.mind.add_node(e,t,n,i);return o&&(this.view.add_node(o),this.layout.layout(),this.view.show(!1),this.view.reset_node_custom_style(o),this.expand_node(e),this.invoke_event_handle(u.event_type.edit,{evt:"add_node",data:[e.id,t,n,i],node:t})),o}return r.error("fail, this mind map is not editable"),null},insert_node_before:function(e,t,n,i){if(this.get_editable()){var o="string"==typeof e?e:e.id,d=this.mind.insert_node_before(e,t,n,i);return d&&(this.view.add_node(d),this.layout.layout(),this.view.show(!1),this.invoke_event_handle(u.event_type.edit,{evt:"insert_node_before",data:[o,t,n,i],node:t})),d}return r.error("fail, this mind map is not editable"),null},insert_node_after:function(e,t,n,i){if(this.get_editable()){var o=this.mind.insert_node_after(e,t,n,i);return o&&(this.view.add_node(o),this.layout.layout(),this.view.show(!1),this.invoke_event_handle(u.event_type.edit,{evt:"insert_node_after",data:[e.id,t,n,i],node:t})),o}return r.error("fail, this mind map is not editable"),null},remove_node:function(e){if("string"==typeof e)return this.remove_node(this.get_node(e));if(!this.get_editable())return void r.error("fail, this mind map is not editable");if(!e)return r.error("fail, node can not be found"),!1;if(e.isroot)return r.error("fail, can not remove root node"),!1;var t=e.id,n=e.parent.id;this.view.remove_node(e),this.mind.remove_node(e),this.layout.layout(),this.view.show(!1),this.invoke_event_handle(u.event_type.edit,{evt:"remove_node",data:[t],node:n})},update_node:function(e,t){if(!this.get_editable())return void r.error("fail, this mind map is not editable");if(u.util.text.is_empty(t))return void r.warn("fail, topic can not be empty");var n=this.get_node(e);if(n){if(n.topic===t)return r.info("nothing changed"),void this.view.update_node(n);n.topic=t,this.view.update_node(n),this.layout.layout(),this.view.show(!1),this.invoke_event_handle(u.event_type.edit,{evt:"update_node",data:[e,t],node:e})}},move_node:function(e,t,n,i){if(!this.get_editable())return void r.error("fail, this mind map is not editable");var o=this.mind.move_node(e,t,n,i);o&&(this.view.update_node(o),this.layout.layout(),this.view.show(!1),this.invoke_event_handle(u.event_type.edit,{evt:"move_node",data:[e,t,n,i],node:e}))},select_node:function(e){return"string"==typeof e?this.select_node(this.get_node(e)):void(e&&this.layout.is_visible(e)&&(this.mind.selected=e,e&&this.view.select_node(e)))},get_selected_node:function(){return this.mind?this.mind.selected:null},select_clear:function(){this.mind&&(this.mind.selected=null,this.view.select_clear())},is_node_visible:function(e){return this.layout.is_visible(e)},find_node_before:function(e){if("string"==typeof e)return this.find_node_before(this.get_node(e));if(!e||e.isroot)return null;var t=null;if(e.parent.isroot)for(var n=e.parent.children,i=null,o=null,r=0;r<n.length;r++)o=n[r],e.direction===o.direction&&(e.id===o.id&&(t=i),i=o);else t=this.mind.get_node_before(e);return t},find_node_after:function(e){if("string"==typeof e)return this.find_node_after(this.get_node(e));if(!e||e.isroot)return null;var t=null;if(e.parent.isroot){for(var n=e.parent.children,i=!1,o=null,r=0;r<n.length;r++)if(o=n[r],e.direction===o.direction){if(i){t=o;break}e.id===o.id&&(i=!0)}}else t=this.mind.get_node_after(e);return t},set_node_color:function(e,t,n){if(!this.get_editable())return r.error("fail, this mind map is not editable"),null;var i=this.mind.get_node(e);i&&(t&&(i.data["background-color"]=t),n&&(i.data["foreground-color"]=n),this.view.reset_node_custom_style(i))},set_node_font_style:function(e,t,n,i){if(!this.get_editable())return r.error("fail, this mind map is not editable"),null;var o=this.mind.get_node(e);o&&(t&&(o.data["font-size"]=t),n&&(o.data["font-weight"]=n),i&&(o.data["font-style"]=i),this.view.reset_node_custom_style(o),this.view.update_node(o),this.layout.layout(),this.view.show(!1))},resize:function(){this.view.resize()},add_event_listener:function(e){"function"==typeof e&&this.event_handles.push(e)},invoke_event_handle:function(t,n){var i=this;e.setTimeout(function(){i._invoke_event_handle(t,n)},0)},_invoke_event_handle:function(e,t){for(var n=this.event_handles.length,i=0;n>i;i++)this.event_handles[i](e,t)}},u.data_provider=function(e){this.jm=e},u.data_provider.prototype={init:function(){r.debug("data.init")},reset:function(){r.debug("data.reset")},load:function(e){var t=null,n=null;return t="object"==typeof e?e.format?e.format:"node_tree":"freemind","node_array"==t?n=u.format.node_array.get_mind(e):"node_tree"==t?n=u.format.node_tree.get_mind(e):"freemind"==t?n=u.format.freemind.get_mind(e):r.warn("unsupported format"),n},get_data:function(e){var t=null;return"node_array"==e?t=u.format.node_array.get_data(this.jm.mind):"node_tree"==e?t=u.format.node_tree.get_data(this.jm.mind):"freemind"==e?t=u.format.freemind.get_data(this.jm.mind):r.error("unsupported "+e+" format"),t}},u.layout_provider=function(e,t){this.opts=t,this.jm=e,this.isside="side"==this.opts.mode,this.bounds=null,this.cache_valid=!1},u.layout_provider.prototype={init:function(){r.debug("layout.init")},reset:function(){r.debug("layout.reset"),this.bounds={n:0,s:0,w:0,e:0}},layout:function(){r.debug("layout.layout"),this.layout_direction(),this.layout_offset()},layout_direction:function(){this._layout_direction_root()},_layout_direction_root:function(){var e=this.jm.mind.root,t=null;"layout"in e._data?t=e._data.layout:(t={},e._data.layout=t);var n=e.children,i=n.length;if(t.direction=u.direction.center,t.side_index=0,this.isside)for(var o=i;o--;)this._layout_direction_side(n[o],u.direction.right,o);else for(var o=i,r=null;o--;)r=n[o],r.direction==u.direction.left?this._layout_direction_side(r,u.direction.left,o):this._layout_direction_side(r,u.direction.right,o)},_layout_direction_side:function(e,t,n){var i=null;"layout"in e._data?i=e._data.layout:(i={},e._data.layout=i);var o=e.children,r=o.length;i.direction=t,i.side_index=n;for(var d=r;d--;)this._layout_direction_side(o[d],t,d)},layout_offset:function(){var e=this.jm.mind.root,t=e._data.layout;t.offset_x=0,t.offset_y=0,t.outer_height=0;for(var n=e.children,i=n.length,o=[],r=[],d=null;i--;)d=n[i],d._data.layout.direction==u.direction.right?r.unshift(d):o.unshift(d);t.left_nodes=o,t.right_nodes=r,t.outer_height_left=this._layout_offset_subnodes(o),t.outer_height_right=this._layout_offset_subnodes(r),this.bounds.e=e._data.view.width/2,this.bounds.w=0-this.bounds.e,this.bounds.n=0,this.bounds.s=Math.max(t.outer_height_left,t.outer_height_right)},_layout_offset_subnodes:function(e){for(var t=0,n=e.length,i=n,o=null,r=0,d=null,a=0,s=null;i--;)o=e[i],d=o._data.layout,null==s&&(s=o.parent._data),r=this._layout_offset_subnodes(o.children),o.expanded||(r=0,this.set_visible(o.children,!1)),r=Math.max(o._data.view.height,r),d.outer_height=r,d.offset_y=a-r/2,d.offset_x=this.opts.hspace*d.direction+s.view.width*(s.layout.direction+d.direction)/2,o.parent.isroot||(d.offset_x+=this.opts.pspace*d.direction),a=a-r-this.opts.vspace,t+=r;n>1&&(t+=this.opts.vspace*(n-1)),i=n;for(var l=t/2;i--;)o=e[i],o._data.layout.offset_y+=l;return t},_layout_offset_subnodes_height:function(e){for(var t=0,n=e.length,i=n,o=null,r=0,d=null,a=0,s=null;i--;)o=e[i],d=o._data.layout,null==s&&(s=o.parent._data),r=this._layout_offset_subnodes_height(o.children),o.expanded||(r=0),r=Math.max(o._data.view.height,r),d.outer_height=r,d.offset_y=a-r/2,a=a-r-this.opts.vspace,t+=r;n>1&&(t+=this.opts.vspace*(n-1)),i=n;for(var l=t/2;i--;)o=e[i],o._data.layout.offset_y+=l;return t},get_node_offset:function(e){var t=e._data.layout,n=null;if("_offset_"in t&&this.cache_valid?n=t._offset_:(n={x:-1,y:-1},t._offset_=n),-1==n.x||-1==n.y){var i=t.offset_x,o=t.offset_y;if(!e.isroot){var r=this.get_node_offset(e.parent);i+=r.x,o+=r.y}n.x=i,n.y=o}return n},get_node_point:function(e){var t=e._data.view,n=this.get_node_offset(e),i={};return i.x=n.x+t.width*(e._data.layout.direction-1)/2,i.y=n.y-t.height/2,i},get_node_point_in:function(e){var t=this.get_node_offset(e);return t},get_node_point_out:function(e){var t=e._data.layout,n=null;if("_pout_"in t&&this.cache_valid?n=t._pout_:(n={x:-1,y:-1},t._pout_=n),-1==n.x||-1==n.y)if(e.isroot)n.x=0,n.y=0;else{var i=e._data.view,o=this.get_node_offset(e);n.x=o.x+(i.width+this.opts.pspace)*e._data.layout.direction,n.y=o.y}return n},get_expander_point:function(e){var t=this.get_node_point_out(e),n={};return n.x=e._data.layout.direction==u.direction.right?t.x-this.opts.pspace:t.x,n.y=t.y-Math.ceil(this.opts.pspace/2),n},get_min_size:function(){var e=this.jm.mind.nodes,t=null,n=null;for(var i in e)t=e[i],n=this.get_node_point_out(t),n.x>this.bounds.e&&(this.bounds.e=n.x),n.x<this.bounds.w&&(this.bounds.w=n.x);return{w:this.bounds.e-this.bounds.w,h:this.bounds.s-this.bounds.n}},toggle_node:function(e){e.isroot||(e.expanded?this.collapse_node(e):this.expand_node(e))},expand_node:function(e){e.expanded=!0,this.part_layout(e),this.set_visible(e.children,!0)},collapse_node:function(e){e.expanded=!1,this.part_layout(e),this.set_visible(e.children,!1)},expand_all:function(){var e,t=this.jm.mind.nodes;for(var n in t)e=t[n],e.expanded||this.expand_node(e)},expand_to_depth:function(e,t,n){if(!(1>e))for(var i=t||this.jm.mind.root.children,o=n||1,r=i.length,d=null;r--;)d=i[r],e>o&&(d.expanded||this.expand_node(d),this.expand_to_depth(e,d.children,o+1)),o==e&&d.expanded&&this.collapse_node(d)},part_layout:function(e){var t=this.jm.mind.root;if(t){var n=t._data.layout;e._data.layout.direction==u.direction.right?n.outer_height_right=this._layout_offset_subnodes_height(n.right_nodes):n.outer_height_left=this._layout_offset_subnodes_height(n.left_nodes),this.bounds.s=Math.max(n.outer_height_left,n.outer_height_right),this.cache_valid=!1}else r.warn("can not found root node")},set_visible:function(e,t){for(var n=e.length,i=null,o=null;n--;)i=e[n],o=i._data.layout,i.expanded?this.set_visible(i.children,t):this.set_visible(i.children,!1),i._data.layout.visible=t},is_expand:function(e){return e.expanded},is_visible:function(e){var t=e._data.layout;return"visible"in t&&!t.visible?!1:!0}},u.view_provider=function(e,t){this.opts=t,this.jm=e,this.layout=e.layout,this.container=null,this.e_panel=null,this.e_nodes=null,this.e_canvas=null,this.canvas_ctx=null,this.size={w:0,h:0},this.selected_node=null,this.editing_node=null},u.view_provider.prototype={init:function(){if(r.debug("view.init"),this.container=a(this.opts.container),!this.container)return void r.error("the options.view.container was not be found in dom");this.e_panel=s("div"),this.e_canvas=s("canvas"),this.e_nodes=s("jmnodes"),this.e_editor=s("input"),this.e_panel.className="jsmind-inner",this.e_panel.appendChild(this.e_canvas),this.e_panel.appendChild(this.e_nodes),this.e_editor.className="jsmind-editor",this.e_editor.type="text",this.actualZoom=1,this.zoomStep=.1,this.minZoom=.5,this.maxZoom=2;var e=this;u.util.dom.add_event(this.e_editor,"keydown",function(t){var n=t||event;13==n.keyCode&&(e.edit_node_end(),n.stopPropagation())}),u.util.dom.add_event(this.e_editor,"blur",function(t){e.edit_node_end()}),this.container.appendChild(this.e_panel),this.init_canvas()},add_event:function(e,t,n){u.util.dom.add_event(this.e_nodes,t,function(t){var i=t||event;n.call(e,i)})},get_binded_nodeid:function(e){if(null==e)return null;var t=e.tagName.toLowerCase();return"jmnodes"==t||"body"==t||"html"==t?null:"jmnode"==t||"jmexpander"==t?e.getAttribute("nodeid"):this.get_binded_nodeid(e.parentElement)},is_expander:function(e){return"jmexpander"==e.tagName.toLowerCase()},reset:function(){r.debug("view.reset"),this.selected_node=null,this.clear_lines(),this.clear_nodes(),this.reset_theme()},reset_theme:function(){var e=this.jm.options.theme;this.e_nodes.className=e?"theme-"+e:""},reset_custom_style:function(){var e=this.jm.mind.nodes;for(nodeid in e)this.reset_node_custom_style(e[nodeid])},load:function(){r.debug("view.load"),this.init_nodes()},expand_size:function(){var e=this.layout.get_min_size(),t=e.w+2*this.opts.hmargin,n=e.h+2*this.opts.vmargin,i=this.e_panel.clientWidth,o=this.e_panel.clientHeight;t>i&&(i=t),n>o&&(o=n),this.size.w=i,this.size.h=o},init_canvas:function(){var e=this.e_canvas.getContext("2d");this.canvas_ctx=e},init_nodes_size:function(e){var t=e._data.view;t.width=t.element.clientWidth,t.height=t.element.clientHeight},init_nodes:function(){var e=this.jm.mind.nodes,t=d.createDocumentFragment();for(var n in e)this.create_node_element(e[n],t);this.e_nodes.appendChild(t);for(var n in e)this.init_nodes_size(e[n])},add_node:function(e){this.create_node_element(e,this.e_nodes),this.init_nodes_size(e)},create_node_element:function(e,t){var n=null;"view"in e._data?n=e._data.view:(n={},e._data.view=n);var i=s("jmnode");if(e.isroot)i.className="root";else{var o=s("jmexpander");l(o,"-"),o.setAttribute("nodeid",e.id),o.style.visibility="hidden",t.appendChild(o),n.expander=o}if(e.topic&&(this.opts.support_html?h(i,e.topic):l(i,e.topic)),i.setAttribute("nodeid",e.id),i.style.visibility="hidden","width"in e.data&&(i.style.width=e.data.width+"px"),"height"in e.data&&(i.style.height=e.data.height+"px"),"font-size"in e.data&&(i.style.fontSize=e.data["font-size"]),"font-weight"in e.data&&(i.style.fontWeight=e.data["font-weight"]),"font-style"in e.data&&(i.style.fontStyle=e.data["font-style"]),"background-image"in e.data){var r=e.data["background-image"];if(r.startsWith("data")&&e.data.width&&e.data.height){var d=new Image;d.onload=function(){var e=document.createElement("canvas");e.width=i.clientWidth,e.height=i.clientHeight;var t=this;if(e.getContext){var n=e.getContext("2d");n.drawImage(t,2,2,i.clientWidth,i.clientHeight);var o=e.toDataURL();i.style.backgroundImage="url("+o+")"}},d.src=r}else i.style.backgroundImage="url("+r+")";i.style.backgroundSize="99%"}t.appendChild(i),n.element=i},remove_node:function(e){null!=this.selected_node&&this.selected_node.id==e.id&&(this.selected_node=null),null!=this.editing_node&&this.editing_node.id==e.id&&(e._data.view.element.removeChild(this.e_editor),this.editing_node=null);for(var t=e.children,n=t.length;n--;)this.remove_node(t[n]);if(e._data.view){var i=e._data.view.element,o=e._data.view.expander;this.e_nodes.removeChild(i),this.e_nodes.removeChild(o),e._data.view.element=null,e._data.view.expander=null}},update_node:function(e){var t=e._data.view,n=t.element;e.topic&&(this.opts.support_html?h(n,e.topic):l(n,e.topic)),t.width=n.clientWidth,t.height=n.clientHeight},select_node:function(e){this.selected_node&&(this.selected_node._data.view.element.className=this.selected_node._data.view.element.className.replace(/\s*selected\s*/i,""),
this.reset_node_custom_style(this.selected_node)),e&&(this.selected_node=e,e._data.view.element.className+=" selected",this.clear_node_custom_style(e))},select_clear:function(){this.select_node(null)},get_editing_node:function(){return this.editing_node},is_editing:function(){return!!this.editing_node},edit_node_begin:function(e){if(!e.topic)return void r.warn("don't edit image nodes");null!=this.editing_node&&this.edit_node_end(),this.editing_node=e;var t=e._data.view,n=t.element,i=e.topic;this.e_editor.value=i,n.innerHTML="",n.appendChild(this.e_editor),n.style.zIndex=5,this.e_editor.focus(),this.e_editor.select()},edit_node_end:function(){if(null!=this.editing_node){var e=this.editing_node;this.editing_node=null;var t=e._data.view,n=t.element,i=this.e_editor.value;n.style.zIndex="auto",n.removeChild(this.e_editor),u.util.text.is_empty(i)||e.topic===i?this.opts.support_html?h(n,e.topic):l(n,e.topic):this.jm.update_node(e.id,i)}},get_view_offset:function(){var e=this.layout.bounds,t=(this.size.w-e.e-e.w)/2,n=this.size.h/2;return{x:t,y:n}},resize:function(){this.e_canvas.width=1,this.e_canvas.height=1,this.e_nodes.style.width="1px",this.e_nodes.style.height="1px",this.expand_size(),this._show()},_show:function(){this.e_canvas.width=this.size.w,this.e_canvas.height=this.size.h,this.e_nodes.style.width=this.size.w+"px",this.e_nodes.style.height=this.size.h+"px",this.show_nodes(),this.show_lines(),this.jm.invoke_event_handle(u.event_type.resize,{data:[]})},zoomIn:function(){return this.setZoom(this.actualZoom+this.zoomStep)},zoomOut:function(){return this.setZoom(this.actualZoom-this.zoomStep)},setZoom:function(e){if(e<this.minZoom||e>this.maxZoom)return!1;this.actualZoom=e;for(var t=0;t<this.e_panel.children.length;t++)this.e_panel.children[t].style.transform="scale("+e+")";return this.show(!0),!0},_center_root:function(){var e=this.e_panel.clientWidth,t=this.e_panel.clientHeight;if(this.size.w>e){var n=this.get_view_offset();this.e_panel.scrollLeft=n.x-e/2}this.size.h>t&&(this.e_panel.scrollTop=(this.size.h-t)/2)},show:function(e){r.debug("view.show"),this.expand_size(),this._show(),e&&this._center_root()},relayout:function(){this.expand_size(),this._show()},clear_nodes:function(){var e=this.jm.mind;if(null!=e){var t=e.nodes,n=null;for(var i in t)n=t[i],n._data.view.element=null,n._data.view.expander=null;this.e_nodes.innerHTML=""}},show_nodes:function(){var e=this.jm.mind.nodes,t=null,n=null,i=null,o=null,r=null,d="-",a=null,s=this.get_view_offset();for(var h in e)t=e[h],a=t._data.view,n=a.element,i=a.expander,this.layout.is_visible(t)?(this.reset_node_custom_style(t),o=this.layout.get_node_point(t),a.abs_x=s.x+o.x,a.abs_y=s.y+o.y,n.style.left=s.x+o.x+"px",n.style.top=s.y+o.y+"px",n.style.display="",n.style.visibility="visible",!t.isroot&&t.children.length>0&&(d=t.expanded?"-":"+",r=this.layout.get_expander_point(t),i.style.left=s.x+r.x+"px",i.style.top=s.y+r.y+"px",i.style.display="",i.style.visibility="visible",l(i,d)),t.isroot||0!=t.children.length||(i.style.display="none",i.style.visibility="hidden")):(n.style.display="none",i.style.display="none")},reset_node_custom_style:function(e){var t=e._data.view.element;"background-color"in e.data&&(t.style.backgroundColor=e.data["background-color"]),"foreground-color"in e.data&&(t.style.color=e.data["foreground-color"]),"background-image"in e.data&&(t.style.backgroundImage=e.data["background-image"]),"font-size"in e.data&&(t.style.fontSize=e.data["font-size"]),"font-weight"in e.data&&(t.style.fontWeight=e.data["font-weight"]),"font-style"in e.data&&(t.style.fontStyle=e.data["font-style"])},clear_node_custom_style:function(e){var t=e._data.view.element;t.style.backgroundColor="",t.style.color=""},clear_lines:function(e){var t=e||this.canvas_ctx;u.util.canvas.clear(t,0,0,this.size.w,this.size.h)},getNodePath:function(e){for(var t=0,n=e;!n.isroot;)t++,n=n.parent;return t},show_lines:function(e){this.clear_lines(e);var t=this.jm.mind.nodes,n=null,i=null,o=null,r=this.get_view_offset();for(var d in t)if(n=t[d],!(n.isroot||"visible"in n._data.layout&&!n._data.layout.visible)){i=this.layout.get_node_point_in(n),o=this.layout.get_node_point_out(n.parent);var a=this.getNodePath(n);this.draw_line(o,i,r,e,a-1)}},draw_line:function(e,t,n,i,o){var r=i||this.canvas_ctx;r.strokeStyle=void 0===this.opts.line_color[o]?"#555":this.opts.line_color[o],r.lineWidth=this.opts.line_width,r.lineCap="round",u.util.canvas.bezierto(r,e.x+n.x,e.y+n.y,t.x+n.x,t.y+n.y)}},u.shortcut_provider=function(e,t){this.jm=e,this.opts=t,this.mapping=t.mapping,this.handles=t.handles,this._mapping={}},u.shortcut_provider.prototype={init:function(){u.util.dom.add_event(d,"keydown",this.handler.bind(this)),this.handles.addchild=this.handle_addchild,this.handles.addbrother=this.handle_addbrother,this.handles.editnode=this.handle_editnode,this.handles.delnode=this.handle_delnode,this.handles.toggle=this.handle_toggle,this.handles.up=this.handle_up,this.handles.down=this.handle_down,this.handles.left=this.handle_left,this.handles.right=this.handle_right;for(var e in this.mapping)this.mapping[e]&&e in this.handles&&(this._mapping[this.mapping[e]]=this.handles[e])},enable_shortcut:function(){this.opts.enable=!0},disable_shortcut:function(){this.opts.enable=!1},handler:function(e){if(!this.jm.view.is_editing()){var t=e||event;if(!this.opts.enable)return!0;var n=t.keyCode;n in this._mapping&&this._mapping[n].call(this,this.jm,e)}},handle_addchild:function(e,t){var n=e.get_selected_node();if(n){var i=u.util.uuid.newid(),o=e.add_node(n,i,"New Node");o&&(e.select_node(i),e.begin_edit(i))}},handle_addbrother:function(e,t){var n=e.get_selected_node();if(n&&!n.isroot){var i=u.util.uuid.newid(),o=e.insert_node_after(n,i,"New Node");o&&(e.select_node(i),e.begin_edit(i))}},handle_editnode:function(e,t){var n=e.get_selected_node();n&&e.begin_edit(n)},handle_delnode:function(e,t){var n=e.get_selected_node();n&&!n.isroot&&(e.select_node(n.parent),e.remove_node(n))},handle_toggle:function(e,t){var n=t||event,i=e.get_selected_node();i&&(e.toggle_node(i.id),n.stopPropagation(),n.preventDefault())},handle_up:function(e,t){var n=t||event,i=e.get_selected_node();if(i){var o=e.find_node_before(i);if(!o){var r=e.find_node_before(i.parent);r&&r.children.length>0&&(o=r.children[r.children.length-1])}o&&e.select_node(o),n.stopPropagation(),n.preventDefault()}},handle_down:function(e,t){var n=t||event,i=e.get_selected_node();if(i){var o=e.find_node_after(i);if(!o){var r=e.find_node_after(i.parent);r&&r.children.length>0&&(o=r.children[0])}o&&e.select_node(o),n.stopPropagation(),n.preventDefault()}},handle_left:function(e,t){this._handle_direction(e,t,u.direction.left)},handle_right:function(e,t){this._handle_direction(e,t,u.direction.right)},_handle_direction:function(e,t,n){var i=t||event,o=e.get_selected_node(),r=null;if(o){if(o.isroot){for(var d=o.children,a=[],s=0;s<d.length;s++)d[s].direction===n&&a.push(s);r=d[a[Math.floor((a.length-1)/2)]]}else if(o.direction===n){var a=o.children,l=a.length;l>0&&(r=a[Math.floor((l-1)/2)])}else r=o.parent;r&&e.select_node(r),i.stopPropagation(),i.preventDefault()}}},u.plugin=function(e,t){this.name=e,this.init=t},u.plugins=[],u.register_plugin=function(e){e instanceof u.plugin&&u.plugins.push(e)},u.init_plugins=function(t){e.setTimeout(function(){u._init_plugins(t)},0)},u._init_plugins=function(e){for(var t=u.plugins.length,n=null,i=0;t>i;i++)n=u.plugins[i].init,"function"==typeof n&&n(e)},u.show=function(e,t){var n=new u(e);return n.show(t),n},e[t]=u}(window);
!function(t){"use strict";var e=t.document,i="jsMind",n=t[i];if(n&&"undefined"==typeof n.draggable){var s=n.util.dom,o=n.util.canvas,h="getSelection"in t?function(){t.getSelection().removeAllRanges()}:function(){e.selection.empty()},a={line_width:5,lookup_delay:500,lookup_interval:80};n.draggable=function(t){this.jm=t,this.e_canvas=null,this.canvas_ctx=null,this.shadow=null,this.shadow_w=0,this.shadow_h=0,this.active_node=null,this.target_node=null,this.target_direct=null,this.client_w=0,this.client_h=0,this.offset_x=0,this.offset_y=0,this.hlookup_delay=0,this.hlookup_timer=0,this.capture=!1,this.moved=!1},n.draggable.prototype={init:function(){this._create_canvas(),this._create_shadow(),this._event_bind()},resize:function(){this.jm.view.e_nodes.appendChild(this.shadow),this.e_canvas.width=this.jm.view.size.w,this.e_canvas.height=this.jm.view.size.h},_create_canvas:function(){var t=e.createElement("canvas");this.jm.view.e_panel.appendChild(t);var i=t.getContext("2d");this.e_canvas=t,this.canvas_ctx=i},_create_shadow:function(){var t=e.createElement("jmnode");t.style.visibility="hidden",t.style.zIndex="3",t.style.cursor="move",t.style.opacity="0.7",this.shadow=t},reset_shadow:function(t){var e=this.shadow.style;this.shadow.innerHTML=t.innerHTML,e.left=t.style.left,e.top=t.style.top,e.width=t.style.width,e.height=t.style.height,e.backgroundImage=t.style.backgroundImage,e.backgroundSize=t.style.backgroundSize,this.shadow_w=this.shadow.clientWidth,this.shadow_h=this.shadow.clientHeight},show_shadow:function(){this.moved||(this.shadow.style.visibility="visible")},hide_shadow:function(){this.shadow.style.visibility="hidden"},clear_lines:function(){o.clear(this.canvas_ctx,0,0,this.jm.view.size.w,this.jm.view.size.h)},_magnet_shadow:function(t){t&&(this.canvas_ctx.lineWidth=a.line_width,this.canvas_ctx.strokeStyle="rgba(0,0,0,0.3)",this.canvas_ctx.lineCap="round",this.clear_lines(),o.lineto(this.canvas_ctx,t.sp.x,t.sp.y,t.np.x,t.np.y))},_lookup_close_node:function(){var t,e,i=this.jm.get_root(),s=i.get_location(),o=i.get_size(),h=s.x+o.w/2,l=this.shadow_w,d=this.shadow_h,c=this.shadow.offsetLeft,_=this.shadow.offsetTop,r=c+l/2>=h?n.direction.right:n.direction.left,u=this.jm.mind.nodes,v=null,f=Number.MAX_VALUE,w=0,g=null,p=null,m=null;for(var y in u){var k,x;if(v=u[y],v.isroot||v.direction==r){if(v.id==this.active_node.id)continue;if(t=v.get_size(),e=v.get_location(),r==n.direction.right){if(c-e.x-t.w<=0)continue;w=Math.abs(c-e.x-t.w)+Math.abs(_+d/2-e.y-t.h/2),k={x:e.x+t.w-a.line_width,y:e.y+t.h/2},x={x:c+a.line_width,y:_+d/2}}else{if(e.x-c-l<=0)continue;w=Math.abs(c+l-e.x)+Math.abs(_+d/2-e.y-t.h/2),k={x:e.x+a.line_width,y:e.y+t.h/2},x={x:c+l-a.line_width,y:_+d/2}}f>w&&(g=v,p=k,m=x,f=w)}}var b=null;return g&&(b={node:g,direction:r,sp:m,np:p}),b},lookup_close_node:function(){var t=this._lookup_close_node();t&&(this._magnet_shadow(t),this.target_node=t.node,this.target_direct=t.direction)},_event_bind:function(){var t=this,e=this.jm.view.container;s.add_event(e,"mousedown",function(e){var i=e||event;t.dragstart.call(t,i)}),s.add_event(e,"mousemove",function(e){var i=e||event;t.drag.call(t,i)}),s.add_event(e,"mouseup",function(e){var i=e||event;t.dragend.call(t,i)}),s.add_event(e,"touchstart",function(e){var i=e||event;t.dragstart.call(t,i)}),s.add_event(e,"touchmove",function(e){var i=e||event;t.drag.call(t,i)}),s.add_event(e,"touchend",function(e){var i=e||event;t.dragend.call(t,i)})},dragstart:function(e){if(this.jm.get_editable()&&!this.capture){this.active_node=null;var i=this.jm.view,n=e.target||event.srcElement,s=i.get_binded_nodeid(n);if(s){var o=this.jm.get_node(s);if(!o.isroot){this.reset_shadow(n),this.active_node=o,this.offset_x=(e.clientX||e.touches[0].clientX)-n.offsetLeft,this.offset_y=(e.clientY||e.touches[0].clientY)-n.offsetTop,this.client_hw=Math.floor(n.clientWidth/2),this.client_hh=Math.floor(n.clientHeight/2),0!=this.hlookup_delay&&t.clearTimeout(this.hlookup_delay),0!=this.hlookup_timer&&t.clearInterval(this.hlookup_timer);var h=this;this.hlookup_delay=t.setTimeout(function(){h.hlookup_delay=0,h.hlookup_timer=t.setInterval(function(){h.lookup_close_node.call(h)},a.lookup_interval)},a.lookup_delay),this.capture=!0}}}},drag:function(t){if(this.jm.get_editable()&&this.capture){t.preventDefault(),this.show_shadow(),this.moved=!0,h();{var e=(t.clientX||t.touches[0].clientX)-this.offset_x,i=(t.clientY||t.touches[0].clientY)-this.offset_y;e+this.client_hw,i+this.client_hh}this.shadow.style.left=e+"px",this.shadow.style.top=i+"px",h()}},dragend:function(e){if(this.jm.get_editable()){if(this.capture){if(0!=this.hlookup_delay&&(t.clearTimeout(this.hlookup_delay),this.hlookup_delay=0,this.clear_lines()),0!=this.hlookup_timer&&(t.clearInterval(this.hlookup_timer),this.hlookup_timer=0,this.clear_lines()),this.moved){var i=this.active_node,n=this.target_node,s=this.target_direct;this.move_node(i,n,s)}this.hide_shadow()}this.moved=!1,this.capture=!1}},move_node:function(t,e,i){var s=this.shadow.offsetTop;if(e&&t&&!n.node.inherited(t,e)){for(var o=e.children,h=o.length,a=null,l=Number.MAX_VALUE,d=null,c="_last_";h--;)if(a=o[h],a.direction==i&&a.id!=t.id){var _=a.get_location().y-s;_>0&&l>_&&(l=_,d=a,c="_first_")}d&&(c=d.id),this.jm.move_node(t.id,c,e.id,i)}this.active_node=null,this.target_node=null,this.target_direct=null},jm_event_handle:function(t,e){t===n.event_type.resize&&this.resize()}};var l=new n.plugin("draggable",function(t){var e=new n.draggable(t);e.init(),t.add_event_listener(function(t,i){e.jm_event_handle.call(e,t,i)})});n.register_plugin(l)}}(window);